function M = M_pressure_2DoF_MSF(p, m, L, r, K, A)
% Intertia Matrix in joint space
% Inputs:
%   p  : Pressures of 2nd and 3rd PMAs [1x3] (Pa)
%   m  : mass of the module [constant] (kg)
%   L  : neutral length of the backbone [3x1] (m)
%   r  : radial offset of the PMA from the centerline [constant] (m)
%   K  : Bending stiffness of the module [consatant] (N/rad)
%   A  : PMA effective area [consatant] (m^2)
% 
% Output:
%   M  : Inertia matrix [2x2]

arguments (Input)
    p (3,1) double 
    m (1,1) double {mustBePositive}  = 0.1
    L (3,1) double {mustBeGreaterThanOrEqual(L,0)} = [0, 0.278, 0]
    r (1,1) double {mustBePositive} = 0.013
    K (1,1) double {mustBePositive} = 0.031
    A (1,1) double {mustBePositive} = pi*(0.013/2)^2
end

arguments (Output)
    M (2,2) double
end

% if p(1) < 1e-4
%     p(1) = 0.11;
% end
% if p(1) < 1e-4
%     p(1) = 0.09;
% end

M = [0.9e1 / 0.25176309760000000e17 * ((p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 16 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 34 * A ^ 34 - 0.610e3 / 0.57e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 15 * K ^ 2 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 32 * A ^ 32 - 0.14075e5 / 0.72e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 14 * K ^ 4 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 30 * A ^ 30 + 0.544535e6 / 0.68e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 13 * K ^ 6 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 28 * A ^ 28 - 0.337510e6 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 12 * K ^ 8 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 26 * A ^ 26 + 0.2589040e7 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 11 * K ^ 10 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 24 * A ^ 24 - 0.3693600e7 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 10 * K ^ 12 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 22 * A ^ 22 + 0.256648000e9 / 0.39e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 9 * K ^ 14 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 20 * A ^ 20 + 0.16464000e8 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 8 * K ^ 16 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 18 * A ^ 18 - 0.3606400000e10 / 0.11e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 7 * K ^ 18 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 16 * A ^ 16 + 0.27872768000e11 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 6 * K ^ 20 * (p(2) + p(3) / 0.2e1) ^ 2 * r ^ 14 * A ^ 14 - 0.173734400000e12 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 5 * K ^ 22 * r ^ 12 * A ^ 12 * (p(2) ^ 2 + p(2) * p(3) + 0.67e2 / 0.277e3 * p(3) ^ 2) + 0.234572800000e12 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 4 * K ^ 24 * r ^ 10 * (p(2) ^ 2 + p(2) * p(3) + 0.31e2 / 0.187e3 * p(3) ^ 2) * A ^ 10 - 0.1063731200000e13 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 3 * K ^ 26 * (p(2) ^ 2 + p(2) * p(3) - 0.52e2 / 0.53e2 * p(3) ^ 2) * r ^ 8 * A ^ 8 - 0.280985600000e12 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 2 * K ^ 28 * r ^ 6 * (p(2) ^ 2 + p(2) * p(3) + 0.43e2 / 0.2e1 * p(3) ^ 2) * A ^ 6 + 0.7867596800000e13 / 0.3e1 * A ^ 4 * K ^ 30 * r ^ 4 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + 0.7e1 * p(3) ^ 2) - 0.393379840000000e15 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + 0.5e1 / 0.2e1 * p(3) ^ 2) * K ^ 32 * r ^ 2 * A ^ 2 + 0.3147038720000000e16 / 0.9e1 * K ^ 34) * r ^ 2 * A ^ 2 * L(2) ^ 2 * m / K ^ 36 0.9e1 / 0.50352619520000000e17 * r ^ 2 * A ^ 2 * L(2) ^ 2 * m * ((p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 16 * (p(2) + p(3) / 0.2e1) * r ^ 34 * A ^ 34 * (p(2) + 0.2e1 * p(3)) - 0.610e3 / 0.57e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 15 * K ^ 2 * (p(2) + p(3) / 0.2e1) * r ^ 32 * A ^ 32 * (p(2) + 0.2e1 * p(3)) - 0.14075e5 / 0.72e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 14 * K ^ 4 * (p(2) + p(3) / 0.2e1) * r ^ 30 * A ^ 30 * (p(2) + 0.2e1 * p(3)) + 0.544535e6 / 0.68e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 13 * K ^ 6 * (p(2) + p(3) / 0.2e1) * r ^ 28 * A ^ 28 * (p(2) + 0.2e1 * p(3)) - 0.337510e6 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 12 * K ^ 8 * (p(2) + p(3) / 0.2e1) * r ^ 26 * A ^ 26 * (p(2) + 0.2e1 * p(3)) + 0.2589040e7 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 11 * K ^ 10 * (p(2) + p(3) / 0.2e1) * r ^ 24 * A ^ 24 * (p(2) + 0.2e1 * p(3)) - 0.3693600e7 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 10 * K ^ 12 * (p(2) + p(3) / 0.2e1) * r ^ 22 * A ^ 22 * (p(2) + 0.2e1 * p(3)) + 0.256648000e9 / 0.39e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 9 * K ^ 14 * (p(2) + p(3) / 0.2e1) * r ^ 20 * A ^ 20 * (p(2) + 0.2e1 * p(3)) + 0.16464000e8 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 8 * K ^ 16 * (p(2) + p(3) / 0.2e1) * r ^ 18 * A ^ 18 * (p(2) + 0.2e1 * p(3)) - 0.3606400000e10 / 0.11e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 7 * K ^ 18 * (p(2) + p(3) / 0.2e1) * r ^ 16 * A ^ 16 * (p(2) + 0.2e1 * p(3)) + 0.27872768000e11 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 6 * K ^ 20 * (p(2) + p(3) / 0.2e1) * r ^ 14 * A ^ 14 * (p(2) + 0.2e1 * p(3)) - 0.173734400000e12 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 5 * K ^ 22 * r ^ 12 * A ^ 12 * (p(2) ^ 2 + 0.697e3 / 0.277e3 * p(2) * p(3) + p(3) ^ 2) + 0.234572800000e12 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 4 * K ^ 24 * r ^ 10 * (p(2) ^ 2 + 0.499e3 / 0.187e3 * p(2) * p(3) + p(3) ^ 2) * A ^ 10 - 0.1063731200000e13 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 3 * K ^ 26 * r ^ 8 * (p(2) ^ 2 + 0.263e3 / 0.53e2 * p(2) * p(3) + p(3) ^ 2) * A ^ 8 - 0.280985600000e12 / 0.3e1 * A ^ 6 * K ^ 28 * r ^ 6 * (p(2) ^ 2 - 0.40e2 * p(2) * p(3) + p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 2 + 0.7867596800000e13 / 0.3e1 * A ^ 4 * K ^ 30 * r ^ 4 * (p(2) ^ 2 - 0.11e2 * p(2) * p(3) + p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) - 0.393379840000000e15 / 0.9e1 * A ^ 2 * K ^ 32 * r ^ 2 * (p(2) - p(3)) ^ 2 + 0.3147038720000000e16 / 0.9e1 * K ^ 34) / K ^ 36; 0.9e1 / 0.50352619520000000e17 * r ^ 2 * A ^ 2 * L(2) ^ 2 * m * ((p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 16 * (p(2) + p(3) / 0.2e1) * r ^ 34 * A ^ 34 * (p(2) + 0.2e1 * p(3)) - 0.610e3 / 0.57e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 15 * K ^ 2 * (p(2) + p(3) / 0.2e1) * r ^ 32 * A ^ 32 * (p(2) + 0.2e1 * p(3)) - 0.14075e5 / 0.72e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 14 * K ^ 4 * (p(2) + p(3) / 0.2e1) * r ^ 30 * A ^ 30 * (p(2) + 0.2e1 * p(3)) + 0.544535e6 / 0.68e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 13 * K ^ 6 * (p(2) + p(3) / 0.2e1) * r ^ 28 * A ^ 28 * (p(2) + 0.2e1 * p(3)) - 0.337510e6 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 12 * K ^ 8 * (p(2) + p(3) / 0.2e1) * r ^ 26 * A ^ 26 * (p(2) + 0.2e1 * p(3)) + 0.2589040e7 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 11 * K ^ 10 * (p(2) + p(3) / 0.2e1) * r ^ 24 * A ^ 24 * (p(2) + 0.2e1 * p(3)) - 0.3693600e7 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 10 * K ^ 12 * (p(2) + p(3) / 0.2e1) * r ^ 22 * A ^ 22 * (p(2) + 0.2e1 * p(3)) + 0.256648000e9 / 0.39e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 9 * K ^ 14 * (p(2) + p(3) / 0.2e1) * r ^ 20 * A ^ 20 * (p(2) + 0.2e1 * p(3)) + 0.16464000e8 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 8 * K ^ 16 * (p(2) + p(3) / 0.2e1) * r ^ 18 * A ^ 18 * (p(2) + 0.2e1 * p(3)) - 0.3606400000e10 / 0.11e2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 7 * K ^ 18 * (p(2) + p(3) / 0.2e1) * r ^ 16 * A ^ 16 * (p(2) + 0.2e1 * p(3)) + 0.27872768000e11 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 6 * K ^ 20 * (p(2) + p(3) / 0.2e1) * r ^ 14 * A ^ 14 * (p(2) + 0.2e1 * p(3)) - 0.173734400000e12 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 5 * K ^ 22 * r ^ 12 * A ^ 12 * (p(2) ^ 2 + 0.697e3 / 0.277e3 * p(2) * p(3) + p(3) ^ 2) + 0.234572800000e12 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 4 * K ^ 24 * r ^ 10 * (p(2) ^ 2 + 0.499e3 / 0.187e3 * p(2) * p(3) + p(3) ^ 2) * A ^ 10 - 0.1063731200000e13 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 3 * K ^ 26 * r ^ 8 * (p(2) ^ 2 + 0.263e3 / 0.53e2 * p(2) * p(3) + p(3) ^ 2) * A ^ 8 - 0.280985600000e12 / 0.3e1 * A ^ 6 * K ^ 28 * r ^ 6 * (p(2) ^ 2 - 0.40e2 * p(2) * p(3) + p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 2 + 0.7867596800000e13 / 0.3e1 * A ^ 4 * K ^ 30 * r ^ 4 * (p(2) ^ 2 - 0.11e2 * p(2) * p(3) + p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) - 0.393379840000000e15 / 0.9e1 * A ^ 2 * K ^ 32 * r ^ 2 * (p(2) - p(3)) ^ 2 + 0.3147038720000000e16 / 0.9e1 * K ^ 34) / K ^ 36 0.9e1 / 0.100705239040000000e18 * (A ^ 34 * r ^ 34 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 16 - 0.610e3 / 0.57e2 * A ^ 32 * K ^ 2 * r ^ 32 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 15 - 0.14075e5 / 0.72e2 * A ^ 30 * K ^ 4 * r ^ 30 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 14 + 0.544535e6 / 0.68e2 * A ^ 28 * K ^ 6 * r ^ 28 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 13 - 0.337510e6 / 0.3e1 * A ^ 26 * K ^ 8 * r ^ 26 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 12 + 0.2589040e7 / 0.3e1 * A ^ 24 * K ^ 10 * r ^ 24 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 11 - 0.3693600e7 * A ^ 22 * K ^ 12 * r ^ 22 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 10 + 0.256648000e9 / 0.39e2 * A ^ 20 * K ^ 14 * r ^ 20 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 9 + 0.16464000e8 * A ^ 18 * K ^ 16 * r ^ 18 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 8 - 0.3606400000e10 / 0.11e2 * A ^ 16 * K ^ 18 * r ^ 16 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 7 + 0.27872768000e11 / 0.9e1 * A ^ 14 * K ^ 20 * r ^ 14 * (p(2) + 0.2e1 * p(3)) ^ 2 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 6 - 0.168089600000e12 / 0.9e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 5 * (p(2) ^ 2 + 0.277e3 / 0.67e2 * p(2) * p(3) + 0.277e3 / 0.67e2 * p(3) ^ 2) * K ^ 22 * r ^ 12 * A ^ 12 + 0.155545600000e12 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 4 * K ^ 24 * r ^ 10 * A ^ 10 * (p(2) ^ 2 + 0.187e3 / 0.31e2 * p(2) * p(3) + 0.187e3 / 0.31e2 * p(3) ^ 2) + 0.4174643200000e13 / 0.9e1 * (p(2) ^ 2 - 0.53e2 / 0.52e2 * p(2) * p(3) - 0.53e2 / 0.52e2 * p(3) ^ 2) * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 3 * K ^ 26 * r ^ 8 * A ^ 8 - 0.24164761600000e14 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) ^ 2 * K ^ 28 * r ^ 6 * (p(2) ^ 2 + 0.2e1 / 0.43e2 * p(2) * p(3) + 0.2e1 / 0.43e2 * p(3) ^ 2) * A ^ 6 + 0.220292710400000e15 / 0.3e1 * (p(2) ^ 2 + p(2) * p(3) + p(3) ^ 2) * K ^ 30 * r ^ 4 * A ^ 4 * (p(2) ^ 2 + p(2) * p(3) / 0.7e1 + p(3) ^ 2 / 0.7e1) - 0.3933798400000000e16 / 0.9e1 * (p(2) ^ 2 + 0.2e1 / 0.5e1 * p(2) * p(3) + 0.2e1 / 0.5e1 * p(3) ^ 2) * K ^ 32 * r ^ 2 * A ^ 2 + 0.12588154880000000e17 / 0.9e1 * K ^ 34) * r ^ 2 * A ^ 2 * L(2) ^ 2 * m / K ^ 36;];

rc = rcond(M);

if any(isnan(M), 'all') || any(isinf(M), 'all') || rc<1e-5
    M = eye(size(M));
end

end